"""Splash and celebration overlays."""

from __future__ import annotations

import math
import random
from typing import TYPE_CHECKING

from textual.widgets import Static

if TYPE_CHECKING:
    from textual.timer import Timer


# ── Splash overlay ────────────────────────────────────────────────────

_SPLASH_ART: list[str] = [
    "[bold #00d7d7]            ██                   [/]",
    "[bold #00d7d7]           ██                    [/]",
    "[bold #00d7d7]          ████████               [/]",
    "[bold #00d7d7]            ███                  [/]",
    "[bold #00d7d7]           ██                    [/]",
    "[bold #00d7d7]          ██                     [/]",
    "                                 ",
    "[#1a3a3a]╺━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╸[/]",
    "[#00d7d7]███████╗███████╗██╗   ██╗███████╗[/]",
    "[#00b5b5]╚══███╔╝██╔════╝██║   ██║██╔════╝[/]",
    "[#009999]  ███╔╝ █████╗  ██║   ██║███████╗[/]",
    "[#00b5b5] ███╔╝  ██╔══╝  ██║   ██║╚════██║[/]",
    "[#00d7d7]███████╗███████╗╚██████╔╝███████║[/]",
    "[#00e8e8]╚══════╝╚══════╝ ╚═════╝ ╚══════╝[/]",
    "[#1a3a3a]╺━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╸[/]",
    "",
    "[#3a6a6a]         ὁ Ζεὺς ἐσήμηνε          [/]",
]


class SplashOverlay(Static):
    """Animated startup splash with typewriter reveal and fade-out."""

    DEFAULT_CSS = """
    SplashOverlay {
        layer: splash;
        width: 100%;
        height: 100%;
        background: #000000;
        content-align: center middle;
        overflow: hidden hidden;
        scrollbar-size: 0 0;
    }
    """

    _reveal: int = 0
    _tick_timer: Timer | None = None

    def on_mount(self) -> None:
        self._reveal = 0
        self._tick_timer = self.set_interval(0.09, self._tick)

    def _tick(self) -> None:
        if self._reveal < len(_SPLASH_ART):
            self._reveal += 1
            self.update("\n".join(_SPLASH_ART[: self._reveal]))
        else:
            if self._tick_timer:
                self._tick_timer.stop()
                self._tick_timer = None
            self.set_timer(0.8, self._fade_out)

    def _fade_out(self) -> None:
        self.styles.animate("opacity", 0.0, duration=0.5, easing="out_cubic")
        self.set_timer(0.55, self._do_remove)

    def _do_remove(self) -> None:
        try:
            self.remove()
        except Exception:
            pass

    def dismiss(self) -> None:
        """Immediately skip and remove the splash."""
        if self._tick_timer:
            self._tick_timer.stop()
            self._tick_timer = None
        try:
            self.remove()
        except Exception:
            pass


# ── Dopamine hit celebration ──────────────────────────────────────────

_SPARKLE_CHARS = "✦✧★✶✸✹❋●✴✵✱"
_BOOM_COLORS = (
    "#ff3366",
    "#ff6600",
    "#ffcc00",
    "#33ff66",
    "#00ccff",
    "#cc33ff",
    "#ffffff",
    "#ff99cc",
    "#66ff99",
    "#ff66cc",
    "#6699ff",
    "#ffff66",
)

_DOPAMINE_ART = [
    "██████╗  ██████╗ ██████╗  █████╗ ███╗   ███╗██╗███╗   ██╗███████╗",
    "██╔══██╗██╔═══██╗██╔══██╗██╔══██╗████╗ ████║██║████╗  ██║██╔════╝",
    "██║  ██║██║   ██║██████╔╝███████║██╔████╔██║██║██╔██╗ ██║█████╗  ",
    "██║  ██║██║   ██║██╔═══╝ ██╔══██║██║╚██╔╝██║██║██║╚██╗██║██╔══╝  ",
    "██████╔╝╚██████╔╝██║     ██║  ██║██║ ╚═╝ ██║██║██║ ╚████║███████╗",
    "╚═════╝  ╚═════╝ ╚═╝     ╚═╝  ╚═╝╚═╝     ╚═╝╚═╝╚═╝  ╚═══╝╚══════╝",
]
_HIT_ART = [
    "██╗  ██╗██╗████████╗██╗",
    "██║  ██║██║╚══██╔══╝██║",
    "███████║██║   ██║   ██║",
    "██╔══██║██║   ██║   ╚═╝",
    "██║  ██║██║   ██║   ██╗",
    "╚═╝  ╚═╝╚═╝   ╚═╝   ╚═╝",
]


class DopamineOverlay(Static):
    """Firework celebration when efficiency hits 80%."""

    can_focus = True

    DEFAULT_CSS = """
    DopamineOverlay {
        layer: splash;
        width: 100%;
        height: 100%;
        background: #000000;
        overflow: hidden hidden;
        scrollbar-size: 0 0;
    }
    """

    def __init__(self, efficiency: float, *, id: str | None = None) -> None:
        super().__init__("", id=id)
        self._efficiency = efficiency
        self._particles: list[list[int | str]] = []
        self._fireworks: list[tuple[int, int, str, int]] = []
        self._frame = 0
        self._tick_timer: Timer | None = None

    def on_mount(self) -> None:
        self.focus()
        self._frame = 0
        self._tick_timer = self.set_interval(0.07, self._tick)
        self.set_timer(5.0, self._fade_out)
        for _ in range(3):
            self._spawn_firework()

    def _spawn_firework(self) -> None:
        w = max(20, self.size.width)
        h = max(8, self.size.height)
        cx = random.randint(4, w - 5)
        cy = random.randint(2, h - 3)
        color = random.choice(_BOOM_COLORS)
        self._fireworks.append((cx, cy, color, self._frame))

    def _tick(self) -> None:
        self._frame += 1
        w = max(40, self.size.width)
        h = max(10, self.size.height)

        if self._frame % 4 == 0:
            self._spawn_firework()

        for cx, cy, color, birth in self._fireworks:
            age = self._frame - birth
            if age > 10:
                continue
            n_rays = 12
            for ai in range(n_rays):
                angle = ai * (2 * math.pi / n_rays) + birth * 0.3
                r = age * 2.0
                x = int(cx + r * math.cos(angle))
                y = int(cy + r * 0.45 * math.sin(angle))
                if 0 <= x < w and 0 <= y < h:
                    ch = random.choice(_SPARKLE_CHARS)
                    ttl = random.randint(3, 6)
                    self._particles.append([x, y, ch, color, ttl])

        for _ in range(3):
            self._particles.append(
                [
                    random.randint(0, w - 1),
                    random.randint(0, h - 1),
                    random.choice(_SPARKLE_CHARS),
                    random.choice(_BOOM_COLORS),
                    random.randint(2, 5),
                ]
            )

        self._particles = [p for p in self._particles if p[4] > 1]  # type: ignore[operator]
        for p in self._particles:
            p[4] = int(p[4]) - 1  # type: ignore[index]

        grid: dict[tuple[int, int], tuple[str, str]] = {}
        for p in self._particles:
            grid[(int(p[0]), int(p[1]))] = (str(p[2]), str(p[3]))

        if self._frame > 8:
            art = _DOPAMINE_ART
            art_w = max(len(line) for line in art)
            ax = (w - art_w) // 2
            ay = h // 2 - len(art) - 1
            colors_cycle = ["#ffcc00", "#ff6600", "#ff3366", "#cc33ff", "#00ccff", "#33ff66"]
            tc = colors_cycle[self._frame % len(colors_cycle)]
            for row_i, line in enumerate(art):
                for col_i, ch in enumerate(line):
                    x, y = ax + col_i, ay + row_i
                    if ch != " " and 0 <= x < w and 0 <= y < h:
                        grid[(x, y)] = (ch, tc)

        if self._frame > 12:
            art = _HIT_ART
            art_w = max(len(line) for line in art)
            ax = (w - art_w) // 2
            ay = h // 2 + 1
            tc2_cycle = ["#ffffff", "#ffcc00", "#ff6600"]
            tc2 = tc2_cycle[self._frame % len(tc2_cycle)]
            for row_i, line in enumerate(art):
                for col_i, ch in enumerate(line):
                    x, y = ax + col_i, ay + row_i
                    if ch != " " and 0 <= x < w and 0 <= y < h:
                        grid[(x, y)] = (ch, tc2)

        if self._frame > 16:
            eff_text = f"Efficiency: {self._efficiency:.0f}%"
            ex = (w - len(eff_text)) // 2
            ey = h // 2 + len(_HIT_ART) + 2
            for i, ch in enumerate(eff_text):
                x = ex + i
                if ch != " " and 0 <= x < w and 0 <= ey < h:
                    grid[(x, ey)] = (ch, "#888888")

        out: list[str] = []
        for y in range(h):
            parts: list[str] = []
            for x in range(w):
                cell = grid.get((x, y))
                if cell:
                    parts.append(f"[{cell[1]}]{cell[0]}[/]")
                else:
                    parts.append(" ")
            out.append("".join(parts))
        self.update("\n".join(out))

    def _fade_out(self) -> None:
        if self._tick_timer:
            self._tick_timer.stop()
            self._tick_timer = None
        self.styles.animate("opacity", 0.0, duration=0.8, easing="out_cubic")
        self.set_timer(0.85, self._do_remove)

    def _do_remove(self) -> None:
        try:
            self.remove()
        except Exception:
            pass

    def on_key(self, event: object) -> None:
        self._dismiss_now()

    def on_click(self, event: object) -> None:
        self._dismiss_now()

    def _dismiss_now(self) -> None:
        if self._tick_timer:
            self._tick_timer.stop()
            self._tick_timer = None
        try:
            self.remove()
        except Exception:
            pass


# ── Steady Lad celebration ────────────────────────────────────────────

_TERMINATOR: list[str] = []
_TERMINATOR_RAW = r"""
 ***********+=*=#@ @@@@@%=++++=+++++++++++++*****+*******************++++++++++++*******+*++**++++++++++++*******+++++******+++**##+#%%*-:::::-------=--:--=
 +*************%*@ -@@@#@-++**++*****+++++++*++++++++++++++++++++++++++*+*+*+++++*++*******+++++*++++++++++++++++++++++++++++=++*****-...:::---------------=
 +++**+++++++*+=+@  @@@%@=-*+++++++++++++++++++++++++++++++++++++++++==+-*++*#=++=#=+++-+--*+++===+*+++++++++++++++++++++====+*#--=..::-=--------:::-==--..
 *+*+**+++++++#++@  @@@%@*:*+++*+++++++++++++++++++++++++++++++++++++*=%*#@+%%%@@%#@@%@@*@@%%#+***+=+++++++++++++++++++++++++==+. ..:::-:-----------::... .*:
 **************+*@= @@@%*@-++*+*++++++++++++++++++++++++++++++++++++++*%@+-:#*-   ..  :  +  * :++==*+++++++++++++++++++++++++**#:.......:::::::::--::*-+@@@@+
 ***********+*+=+@@ @@@@+@:=**++++++++++++++++++++++++++++++++++*%@@%#@ .  .+ - :=@@@    -@ := -+:-++++++++++++++++++++==++====*..-.::::::::::::.-..=@=-: :#
 *++**+*********+*@ +@@@=@:=#=#*+++++++++++*++++++++**++++++++*+#* :@@#@-   =%#@@@%:* #@@@@%@@@@=#*-=+==+++++++++++++++++++++++#..:........:...:::..=@ .:..@
 **************#*#@  @%@-@=-*+*+++++++++++++++++++++++++++++++%@%@     *:   .@@.*@@@@@@@@@%#@@@@%@@+#=*#++++++++++++++++++++=++#..::::::::::::::::..=@ .:. %
 ########******#*#@  @%@+@*-*+++++++++++++++******++++++++++++%* @.    +%.:=+. %@@@#%@###@*+@=###==.@=.-*++++++++++++++++++==++#:..:::::::..:...... -@ ::. @
 ********###*#*@%@@ -@@@*%%:*=++++++++++++++*+++++******==%+#@@@     .@  +@ :%@%@@@@@@@@@@%@@%+@#@-#%+- .-*+++++++++++++++=+=++*.:-:------------:.=.+@  .. *
 **********#*#*#%#*+@@@@@#@:++++++++++++++++**++++++++++*#**%   .#.   -%.%@@@@@@@@%%%@@%@@@@@%+@*=@#:#@@*-++++++++++++++++++=++*..:::::----------:=.*@.---:@
 +++++*++***+##*@@@@@@%@%+@-=+*+++++++++++++++++++++++++*--+@@%   .   #:* ==#@@@@@@@@@@@@@@@@@@@@@+#=@*-+-=++++++=====++++===++*..:::--------=--==-.%@.+=-=@
 ++++++++***#*+=*  @@%@%@=@:=+#+++++++++++++++++++++++++=*%*%   .=@#@@@. =*%#+==+++++++=--=-:=:%@@@@@%##:@*+++++==++++++++++=++*..:::-----::::::-=:.%@ =:.-@
 +++++++++++++@.@*@@@%@%@*@:*=++++++++++++++++++++++++++++=%@    %@+=   %@##***********###*%#=.  .+@@@+-.*==++++++++===++==+=++*.:---:::--:--------.%@.=:.+@
 ++++++++++++#. @@@@%=@%@%@-=++++++++++++++++++++++++++++=+@*  *@@+    %@#*######*#####*+*+###==-.  #@@@@+.-**=++++++++**++==++*..:::::::-:-----:--.%@ -:.=@
 ++++++++++*+## -@%@#+@@@@@+-*=++++++++++++++*****++++++*+@=  .*@=    @@%+%*****#*+++++*#*=**++-+*=: #@@+ -==*#*##%#%@@%#+=++++*.:::::::-----------.@@ -:.+@
 ++******+++*#%  @@@@=@@@@@#.*+++++++++++++++++++++++++++++      .    @@=%####****####**##*##+*+-:-= -@@@@@@@###*=-=. .  ++-==+*..:::::::::::-:-::: %% --.:@
 +********++*#@  @@@@+@@@@@%.+*+++++++++++++++++++++++++*+@@= . ==    -@##*#**#*****##**#*+*#+=-     =@#+  .             :*+==+*..:::::::::::----:- @% --.:@
 ************#@  @@@@*@@@@@@.=+++++++++++++++++++++++++++++=@  . =     @+*-*****+*#####**=-==-:      +%-#@*@.            =#+==+*..:::::::::::::-::: %% ::.:@
 ************#@  @@@@#@@%@@@.=++++++++++++++++++++++++++**=@@   ..    +@++:=-==+++***+*+-:::::-.    .@@+*#+     .     .  *#-+==*..:::::::::::::::-:.@% -:.-@
 *************@  +@@@#%@%@@@.=+++++++++++++++++++++++++++==%-   =       .@@@@@#+-==+=-=*%@@@%%*+:     =+=@@.             -*=*=+*..:::::::::::::::-. @# -:.=@
 **###*##**#**#.  @@@%#@%@@@--++++++++++++++++++++++++++=*=#@       #@@@@@@@@@@@@%#*#@@@@@@@@@@@@@@@+-.%:--              *#-===*..::::::::::::::::. @# -..-@
.*************#:  %@@%#@@@%@=:+++++++++++++++++++++++++===+*@   :@@@@@@@@@@%%%@@@@@@@@@%%@@@@@@@@@@@@% #+*%   .          +#====*..::::::::::::::.-. @# :. -@
.*%######****#@=  @@@@#%@%@@=:++++++++++++++++++++++++++%+*#@:   @ -@%@@%@@@@%#@@@+*%@@@@@%%@@@@@@%==. *.=*              +#-=++*...:.::::::::::::.: @* ...+@
 *###*####**###%  @@@@#%@%@@#.*++++++++++++++++++++++++==:#*%@     .@%@@%@%%@@@@@**--#@@@@@@@@@+-@##@. @@+               +#====*...::.:.:.:::::::.: @* .. =@
.#%%#*%%%###%##@  #@@@#%@%@@@ *+++++++=++++++++++++++++++=+## *  .@@@%@@@@@%%%@@*+#+: +@@@@@@%%@@@@@+  @@.               +#=+==*..:.....:..:....:.: @* .: =%
.##*#%%#####**%@: %@@@@%@%%@@ ==++++++++++++++++++++++===+=*= .+   +@@@@@@@@@@@%#*%%%@@@@@@@@@@@@#=    .*@+@+            %+-===+..............:::.  @+ .: *#
.*########*##*%@  =@@@@*#@@@@:++++==+++++++++++++++++==+-=+@@       -=-=+*%%#*=+%+#%*.  -+-*+--:  -.   .+  @             %+====*........:...:.::::  @+ :: *#
.*****###**##*@#   @@@%@@@@@@.-=++++++++++++++++++++====++=+@  +    @@+=--++**=---++:    -*==:-+=-:    :#* @             %+-===+............:.::..  @+ .: *#
 ***#*#%%#####@#   @@%@@# =#+ +++====+++++++++++++++++==+=++@  ..   :#*****+**#@@@%*+%@@..%*@==+-.:     .@*:             %+-===*............:.::..  @+ .: **
 +****++=+#**+@=   @@@@@@#@@%.++++++++===========+======*=+=@+ .    @##+*+#%%%####%%@#. =*%#+=++#**:   @@#               #+=-==+ .........:::::::...@- :: %*
 ---=-*==%%%%+@=   @@@@@@*@@@.=+=++=++++++++++++++=+=+===-++@# +@: .@*#@@@#++*#%%#*@@@#.+:.-.  :+#%*   ==.               #+=-==+ ..:....::.::::::. .@= :: %*
+@@@@@@*%@=*@@@    @@@@@@=@@@.:+==++++======++++++=+=+==+=*+#-  @- :@@@*  %@#*+==*#=-=::. .-.    .==  * =                #+=-==+ ....:.::.:::.:::...@= :: %*
+@@@@@@@@#  .@+    %@@@@@:@@@ :+========================-=+*#@%..  :@    #%=+%@@@@#%@@@@#  +.+    -+ .%=                 %+==+=+ ...:..:..:::::::...@:..: %=
=@@@%@%@@#  :@=    *@@@@@=@@@. ++=================+=+=====+*+++#@. **   -@*@@%%*+#+*+- .%@@@@%    =:  :                  %=-===+ .::...:...::::::...@:..: %+
+@@@%@%@@+  :@=    :@@@%@#*@@+.=+++===++++=====+++========+*++*%*. ++   @@%+++***%@@%%+.  *@@#    :.                     #=--=-+..:....:...:::::.:..@:..: %+
-@@@@@%@@# .+@=     @%@%@%=@@%:==+==+====================++*+++*#@      %@####+**====#%#*  =@#    .= .                   #+--==+..:.:..:.:.:::::.: .@:..: @=
.@%%%%#%@=  -@=     @#@@@@-@@@:-===++======+++=+==+=====+=+++++=+#@-     @@%+###**#**+*%@@+---.-  + .                    ++----+.......:.:::::::.: .@. :: @-
.@%%%#@@@# .*@=     @#@%@@-@@@-:===========+=+====+=======+++++*+++@      :@@%*+##**+=--..::.    .+@  @@                 ==:---=...:...:...:::::.: .@..:. @-
-@@@@%@@@=  +@=     @%@%@@-@@@*:==========================++++=*=#=@- .=    #%##*+***==-     ..:#@@  #@.                 ==:---=...:...:...:::::.: .@..:. @-
.@@@@@@@@%.-*@:     %@@@@@#@#:* =*-+-===================-=**++++=++#@  @    +@*+***####*+:  .+@@@-  +@.  :               -:..:-+....:...:.....:::: -@ .:: @:
 =-.::=-*+.=*@:     =@@@@@#+@@@..*-+====================-=*+++*+=+++@  @@    =@#%##%@%%@@*#@@%%+. :@@  :@@@@             -..  .- .:...:.::..:.:::: :@.... @:
:@@@@@@@@%:=*@:      @@@@%%=@@@- +-++=++====++==========-=**++++=+**@  %@-  #*=@@@@@@@%%%@@#+*==*@@@..@@@#@@@*           -.....-..:......::.:.::.. :@ ... @.
=@@%@@@@@- .+@=    . @@@%@@=@@@= =-====================--=*+==++=+++@*  @. *@@#**++===+*#***#**@@@@@@@@@@@%@@@@@         ----.-+.........:.:.:::.:.-@ .:. @.
-@%@@@@@@+--*@-    = @@@@@@+@@@* ======================-==++++++++++#@  @=  @**+=+*+*#####**#*%@@@%@@@@@@%@@@@%=#*       ..  .:+...........:..::.: :@ .:. @.
-@%@@@%%@-.:*@-    + @@@#@@#@@@@ -=--==================--=++++++++++*@  @@  +*#+%#*#%######%@@@@@@%@%%@@@@@%@@*:@@@@@@@.       :.............::..: :@ .:. @.
-@%%@@@@@*-=*@=    % =@@@@@#%@@@ :+=-+=================--=**+++=+++++@   @@@@***##%%%#++++*%@@@%#%%@%%%@@@@@@@@@@@@@@@@@@@@@%-    .....:.......:.: -@ ... @.
:@@@@@@@@=.=+@:    @ =@@%@@%=@@@..-=-=-===============--==++=++#*=+*+*@  @%*#%%%@#******#%@@@%@@@@@@@@@@%%@@@@@@%%%@@@@@@@@@@@@@-      ...:::.::.- +@ .:. @.
.@%@@@%@@+:+*@=    @  @@@@@@+@@@* -===================--==*+=++=+-%# =@@ -@***+==++*###@@@@@@@@@@%@%@@@@%%@@%@@%@@@@@@@@@@@@@@@@@@@@@%     .:....: +@ .:. @.
.@@@@@@@@+:+*@-    @  @@@@@%=@@@@ :===================--==++=+#=:@  .@@@  @*#@@@@@@@@@@@@@@@@@@@@@@%@@@@%%@@%%@%@@@%%%%#%@@@%@@%@@@#@@@@@@=   ...: =@ .:. @
 =:.-=-#*==*+@.    #: @@@@@@#%@@@..--------=-==-------=-===*=#+** =@@@@@  @@@@@@@%@@%@@@@@%%@@@@@@@@@@%@%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#=  .. +@ .:..@
 %%#%@+#*=-**@.    #: @@@@%@#%@@@: -=-====-===-========--++*-=*. @@@#%@@  @@%@@@@%%%@@@ =@%@@@@@@@@@@@@@@%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@  .@:....@
-@@@@@@@@+:=+@     %- @@@@%@#%@@@% ==-=====--==---====-:.#*+*@  @@@#@@@@  @@@@%@@%@@@  @@@@%@@@@@@@@@@@@@@%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
.%@%%%@@@+=+*@.   .%+ @@@@@@#%@@@@ -=-========-------=--*+#@- @@@%%@*@@-  @@@@@@@@@# *@@%#%%@@@@@@@@@  @@%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%@@@
-@%@%%%@@*=++@.   :*+ =@@@@%@@%@@@ .--========-====+.==-=%+  @@@%@@@@#@@: *@@@@@@# *@@@@@@@@@@@@@@%@@@@@%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%@%%@@@%
-@%@%@%@@+=+*@.   -*= .@@@@%@%%@@@= =======--==---.+==-#@  @@@#%%%@@@@@+  =:=+#@  @@@#%@@@@@@@@@@@%@@@@@#%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%@@@%*+@@@.
=@@@@@%@@*=+*@.   +*=. @@@@@@%%%@@# =======--=-====++#   @@+@@@@%@@+  :++=:::#- %@@%%@@@@@@@@@@@@@%%@%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%@@@@ @@@@@@@ %: .@
-@%@@@@@@+=*+@    -*.- @@@@@@@@%@@@ ==--------=-:.+*.  @@@ #@%%@@@. @@@#*=#+@  @@@@@@@@@@@%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%@%%@@@# =@@@%@:  .**.
+@@@@@@@@+==*@-   *+:% @@@@@@@@%@@@ :=========+==*.  @@@@ @@@@%@@@ -*=++*#=* *@@@@@@@@@%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%@@#@@%#%@@@@%@@@@@@  +@
.%*#@@@@@+=+*@.   ++:# @@@%%@@@@@@@..=-------.*=  .@@@@= @@@*@%@@#-%@#*.=%  @@@%@@@@@@@@@@@@@%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%@@@@. .@@@@@@  +.
 +=++=-**--+*@=   +::+ @@@@@@@@%@@@# -:*:-*=-   .@@@@@@  @@@@@%%@% *%:-#* +@@@@@@@@@@@@%@%%*@@@%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%@@@@   @@@@@# .
#@@@@@@@@#+++@#..+@=++ -@@@@@@@@@%@@ -=.-+:   @@@@@@@@  @@@@@%%%@@: .*@  .@@@%@@@@@@@@@@@@@@@%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%@%#%@@@@%-  *@@@@
#@@@@@%@@+=+#@.   -::-. @@@@@@@@@@@@...+= :@@@@%@@@@@  @@@@@%%%@@-@@#+  @@@%@@@@@@@@@@%%*.+@@%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%@@@@@@@@@-    @@@@
+%@@@@@@@*-++%:  .++=-: @@@@@@%@@@@@: ++:%@  .@@%@@@  @@@@@@@@@#:@@#+  @@@%@@@@@@@@@@%%*.+@@%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%@@@@@@@@@-    @@@@
#@%%@@%@@*=+*@   .+---. @@@@@@@@@%@@% .::.%@%@@@@@@  @@%@@@@@@%@@%@#  @@@@@@@@@%=:-*%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%%@@%*-.  .@@@
#@%@@@%@@+-+*@=  =+=+=* #@@@@@@%@@%@@+-=+= :@@@@@   @@@@@@@@@@@@@@   @@@.:-   -%@@@@%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%@@@%*=:-   @@*
#@%%@@%@@+-+*@:  :+::*. @@@@@@@@@@@@@+ -=--+       @@@#%@@@@@@%@@  @@:    @@@@@@@%%@@%%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%%%@@@@=      @@
+%@@@@*@@+-+##.  -=-+=: @@@@@@@@@@%@@= =:+**      @@@@@%%@@@@@@@. @   .%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%@-..   .@
#@@@@@@@@*==#@:  =++*-  @@@@@@@@@@@@@@ ==-#- .   +@@%%@@@@%#@@@     @@@@@%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%@@-  :   -
.=+++=+#*-=*%%-  =++  @@@@%@@@@@@%@@@@ -:+%     -@@%@@@@%@@@@@   *@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%@@@%@%@@@@@%. .
*@@@@@@@#==#@@*..#+=-@@@@@%%@@@%%@%@@ .==**     @@@@@%#@@@@@@  @@@@%@@@@%*@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%@@@@@%@%@@+@@@  ..
#@@@@@@@@+=#     .*# %@@%@@@@@@@%@@@@ .-*%     @@@@@@#@@@@#  @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@%*%@@@%@@@@%#@@@#  .-
#@%@@@@@@+=#@*. .+-  +@@%@@@@@@@@%%%@. ##.    @@@@@%@@@@@  @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#%@@@@@%@@@%%%%@   =.
*@%%@@%@@+-+*==++:.  @@%@@@@@@@@%%@@@% +=    @@@@@@@#@@  %@@@%@@@@@%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%@@@@@@@@@@@@@@@@@@@@@@@@@@%%%*%@@@@%%@%@%%@@@%   +
+@@@%%@@@+=##:.--:  @@#%@@%@@@@@@@%@@@ %    .@@%@@@@@@  @@@%%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#%@%@@@@@@@@*=##@=  *
+@@@%@@@@+=*#:.-:: @@@@@#@%@@@@%@@@@@#.%   .@@@@%%%%@@-@@@%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#%@%@@@@%@@@%*@@@.
+@@@%%@@%==**-:-:: =@@@%@@%@@@@@@@@%@:.    @@%@@@@@@@.%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#%@%@@@%%@@@@#. %@@
#@@@@@@@@*=*+--=:.. +@@%@@@@@@@@%@@@@.*   @@@@@@@@#@=:@@@@@@@@@@@@@@@@@@%%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#%@%@@@%%@@@@@: .@@+
+@@@@@@@#*+*+-:=-:.  @@@#@@@@@@@%%%@+:   #@@@@%%@@@@.=@%@@@@@@@@%%@%%#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#%@%@@@@%@@@@@*  :@@
 ...::====+**--=-::@@@@%%@@@@@@#@%@@.=  -@@#@@@@@%@@ #@@@@@@@@@@%@@@@%@%%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%@@#%%%%@@@@@@%@@@    @@
 ++***++++**#+=+-.  -%@%#@@@@@@%@@@ .  =@@@%@@%@@@@% @@%@@@@@@@@%%@@%=#@@@%%%%%%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%@@*%%##%@@@%@%@@@*  .-@
 ++++++++++*=++-=-. +@@%@@@@@@@#@@# -  @@@@%@@@@@@@@=@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%@@@%#%@@%@@%@@@%@@    +
 +++*****++**##   -.*@@@@@@@@@@@@% % =@@@@@@@@@@@@@#.@%@@@@@@@@@@@@%@%%@@%@@@@@@@@%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%@@##%#@@%@@%@@@%@@+.  .
 +++++====++*#  @@@@@@@@@@@@@@@@+ :- @@@@@%#@@@@@@@%=@@@@@@@@@@@@@@%@%#@@%@@@@@@@@%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%:#@%@@%@@@%%@@@@@+
 ++++++%#=+###  *%#*#==@@@%@@@@@ .=* @@@@@@@@@@@@@@@+@@%@@@@@@@@@@@%@%%@%%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%@#@%##%@@%@@@@@@@@%
 +++++--+*==+@  - .=+#%#%@@@%@@# : - @@@@@@@@@@@@@@@*@#%@@@@@@@@@@@%@%@%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%@@@-#%%#@@@%@@@@@@@@@+
 +++++***=-%@@: @@@#*##*=#@@#@@+ .-- *@@@@@@@@@@@@@=.@@@@@@@@@@@@@@%@@@%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%@@@-#@%#%@@@@@@%@@@@@@
 +++++===*@#    @@@@@--=..%@%@@@@@@@@@@%@@@@@@@@@@@- @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%@#@@%#%@@@@%@@@@%@@@
 ++++++=++@.   .@@@@@@@@#@@@@#=##%@@@@%%@@@@@@@@@@@* @@%@@@@@@@@@@@@@@@@@@@@@@@%%%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%@@+#@@*#@@@@@@@@@%@@@.
 ++++++*++@*   @*+#*+*%@@@@@@+++#@@@%%@@@@@@@@@@@@@* @@@@@@@@@@@@@@@@@@@@@@@@@@%@@%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%@@#%@@%%@@@@@@@@@@@@@%
 +++++#=+@.   @@*****+**+#@@@%+-%@%@@@@@@@@@@@@@@@@@-@@%@@@@@@@@@@@@@@@@@@@@@@@%%%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%@@@%%%@@@@@@%%@@@
 ++++++*#%    @*=@%***##++%@@@@@@@@@@@@@@@@@@@@@@@@@+#@@@@@@@@@@@@@@@@@#%@%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%@@%%%%%@@@@@@@@%@@#
 +++++++@#   *@**@%@@@**+#@@%@@@@@@@@@@@@@@@@@@@@@@@=#@%@@@@@@@@@@@@@@@#%@%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%@@@@%%@@@@@@@%@@@@@
 ++++++=@  @.@@*##*+==#@@@@%*@@@%@@%%%@@@@@@@@@@@@@@=#@%@@@@@@@@@@@@@@@#%@%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%%%%@@@@@@@@@@@@%%@@@@
 +++++#*+   %@=@@=-#+#%*=%@@@@%@@@@@@@@@@@@@@@@@@@@@+*@%@@@@@@@@@@@@@@@%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%@%@@@@@@@@@@@@@@@@%@@.
 ++*+++*#   @@#%@@@@##=-+#@%@@#@@@@@@@@@@@@@@@@@@@@@*=@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%%%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@*
 ++*++*%@@ @@=%+:*+##@@@@@@+*%@@@@@@@@@@@@@@@@@@@@%@#-@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@*
 +**++*-*#%@@ +%-**+*@%##@@%@@@@@@@@@@@@@@@@@@@@@@#@#-@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@*
 +++*++++=:%@@@@@+===--:.%%@@@@@@@@@@@@@@@@@@@@@@@@@%-@@@@@@@@@@@@@@@@@@%%@@@@@@@@@@@@@@@@@@@@@@@@@#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#
 ++**+%**#=-#  =@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%-@@@@@@@@@@@@@@@@@@%%@@@@@@@@@@@@@@@@%@@@+-@@@%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#
 +*****==+=## @@@@@@@@@@%@@%%%@@@@@@@@@@@@@@@@@@@@@@@+@@@@@@@@@@@@@@@@@@%%@@@@@@@@@@@@@@#%@@@ * .@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#
 =+==-=====+=@@@%@*@@@%%%@@@@@@@@@@@@@@@@@@@@@@@@@%@@:@@@@@@@@@@@@@@@@@@@*@@@@@@@@@@@@@@@@@@#. =@@@#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%@%@%%%@@@@@@#
 -===========+@@@@@@#%@@@@@@@@@@@@@@@@@@@@@@%@@@@@%@@:@@@@@@@@@@@@@@@@@@@*@@@@@@@@@@@@@@%%%@@@@@@%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%@@@@@@@@@@@@#
#@@@@@@@@@@@@@ .@@@@@@%%@@@@@@@@@@@@@@@@@@@@@@%@@@%@@:@@@@@@@@@@@@@@@@@@@*@@@@@@@@@@@@@%@@@%%@@@@@@%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%@@%%@@@@@@@@#
#@@@@%%%%%%%@@#     @@@@@@@@@@@@@@@@@@@@@@@%@@@@@@@@@:@@@@@@@@@@@@@@@@@@@*@@@@@@@@@@@@@%%%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%@@##@@@@@@@@@#
"""
for _line in _TERMINATOR_RAW.split("\n"):
    if _line.strip():
        _TERMINATOR.append(_line)
_TERMINATOR = _TERMINATOR[:57]  # head + shoulders, cut torso

_TERM_CHAR_COLOR: dict[str, str] = {
    " ": "",
    ".": "#222233",
    ":": "#333344",
    "-": "#444455",
    "=": "#555566",
    "+": "#666677",
    "*": "#778899",
    "#": "#99aabb",
    "%": "#aabbcc",
    "@": "#ccddee",
}
_TERM_DEFAULT_COLOR = "#778899"

_STEADY_LAD_ART = [
    "╔═╗╔╦╗╔═╗╔═╗╔╦╗╦ ╦  ╦  ╔═╗╔╦╗",
    "╚═╗ ║ ║╣ ╠═╣ ║║╚╦╝  ║  ╠═╣ ║║",
    "╚═╝ ╩ ╚═╝╩ ╩═╩╝ ╩   ╩═╝╩ ╩═╩╝",
]

_FIRE_CHARS_BOTTOM = ("█", "▓", "▒", "░")
_FIRE_COLORS = ("#cc1100", "#ff3300", "#ff6600", "#ff9900", "#ffcc00")


class SteadyLadOverlay(Static):
    """Terminator + fire animation at 50% efficiency."""

    can_focus = True

    DEFAULT_CSS = """
    SteadyLadOverlay {
        layer: splash;
        width: 100%;
        height: 100%;
        background: #000000;
        overflow: hidden hidden;
        scrollbar-size: 0 0;
    }
    """

    def __init__(self, efficiency: float, *, id: str | None = None) -> None:
        super().__init__("", id=id)
        self._efficiency = efficiency
        self._frame = 0
        self._tick_timer: Timer | None = None

    def on_mount(self) -> None:
        self.focus()
        self._frame = 0
        self._tick_timer = self.set_interval(0.07, self._tick)
        self.set_timer(6.0, self._auto_dismiss)

    def _tick(self) -> None:
        self._frame += 1
        w = max(40, self.size.width)
        h = max(20, self.size.height)

        grid: dict[tuple[int, int], tuple[str, str]] = {}

        f = self._frame
        for y in range(h):
            vert = y / max(1, h - 1)
            for x in range(w):
                cx = abs(x - w // 2) / max(1, w // 2)
                intensity = 0.3 + 0.5 * vert + 0.2 * cx
                wave = 0.15 * math.sin(x * 0.3 + f * 0.25 + y * 0.1)
                intensity += wave + random.uniform(-0.08, 0.08)
                intensity = max(0.0, min(1.0, intensity))
                if intensity < 0.25:
                    continue
                ci = min(int(intensity * (len(_FIRE_COLORS) - 1)), len(_FIRE_COLORS) - 1)
                bi = min(
                    int(intensity * (len(_FIRE_CHARS_BOTTOM) - 1)),
                    len(_FIRE_CHARS_BOTTOM) - 1,
                )
                grid[(x, y)] = (_FIRE_CHARS_BOTTOM[bi], _FIRE_COLORS[ci])

        art = _TERMINATOR
        art_w = max(len(ln) for ln in art)
        ax = (w - art_w) // 2
        ay = h // 2 - len(art) // 2 - 3

        for i, line in enumerate(art):
            for j, ch in enumerate(line):
                x = ax + j
                y = ay + i
                if 0 <= x < w and 0 <= y < h and ch != " ":
                    color = _TERM_CHAR_COLOR.get(ch, _TERM_DEFAULT_COLOR)
                    if color:
                        grid[(x, y)] = (ch, color)

        if self._frame > 10:
            sl_art = _STEADY_LAD_ART
            sl_w = max(len(ln) for ln in sl_art)
            sx = (w - sl_w) // 2
            sy = ay + len(art) + 2
            tc_cycle = ["#ffcc00", "#ff6600", "#ffffff"]
            tc = tc_cycle[self._frame % len(tc_cycle)]
            for i, al in enumerate(sl_art):
                for j, ch in enumerate(al):
                    x = sx + j
                    y = sy + i
                    if 0 <= x < w and 0 <= y < h and ch != " ":
                        grid[(x, y)] = (ch, tc)

            eff_text = f"Efficiency: {self._efficiency:.0f}%"
            ex = (w - len(eff_text)) // 2
            ey = sy + len(sl_art) + 1
            if 0 <= ey < h:
                for j, ch in enumerate(eff_text):
                    x = ex + j
                    if 0 <= x < w and ch != " ":
                        grid[(x, ey)] = (ch, "#888888")

        out: list[str] = []
        for y in range(h):
            parts: list[str] = []
            for x in range(w):
                cell = grid.get((x, y))
                if cell:
                    parts.append(f"[{cell[1]}]{cell[0]}[/]")
                else:
                    parts.append(" ")
            out.append("".join(parts))
        self.update("\n".join(out))

    def _auto_dismiss(self) -> None:
        self._dismiss_now()

    def _dismiss_now(self) -> None:
        if self._tick_timer:
            self._tick_timer.stop()
            self._tick_timer = None
        try:
            self.remove()
        except Exception:
            pass

    def on_key(self, event: object) -> None:
        self._dismiss_now()

    def on_click(self, event: object) -> None:
        self._dismiss_now()
